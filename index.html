<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diet-Plan</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2E7D32">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Diet-Plan">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="icon" type="image/png" href="icons/icon-192x192.png">
    <link rel="manifest" href="manifest.json">
    
    <style>
        /* ... (keep all your existing CSS styles) ... */
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 id="user-header">üë§ User</h1>
            <div class="header-controls">
                <button class="settings-toggle" id="settings-toggle">‚öôÔ∏è</button>
                <button class="mode-toggle" id="mode-toggle">üåô</button>
            </div>
        </header>

        <!-- Home Tab -->
        <div id="home-tab" class="tab-content active">
            <!-- ... (keep all your existing HTML structure) ... -->
            
            <div class="progress-section">
                <h2 class="section-title">üíß Water Tracker</h2>
                <div class="water-tracker">
                    <div class="water-container">
                        <span id="water-count">0</span>
                        <div class="water-progress">
                            <div class="water-fill" id="water-fill" style="width: 0%"></div>
                        </div>
                        <span>/ <span id="water-goal-display">4</span>L</span>
                    </div>
                    <div class="water-controls">
                        <button class="water-btn" id="water-minus">-</button>
                        <button class="water-btn" id="water-plus">+</button>
                    </div>
                </div>
            </div>
            
            <div class="weight-log" id="weight-log">
                <!-- Weight entries will be added here -->
            </div>
        </div>
        
        <!-- ... (keep all your other HTML tabs and modals) ... -->
    </div>
    
    <!-- ... (keep all your modals) ... -->
    
    <div class="nav-bar">
        <button class="nav-btn-bottom active" data-tab="home-tab">üè† Home</button>
        <button class="nav-btn-bottom" data-tab="plan-tab">Plan</button>
        <button class="nav-btn-bottom" data-tab="progress-tab">Progress</button>
        <button class="nav-btn-bottom" data-tab="tips-tab">üí° Tips</button>
    </div>
    <button class="install-btn" id="installButton">
        <span>üì≤</span>
        Install App
    </button>
    
    <script>
        // User Profile
        let userProfile = {
            name: "",
            height: 0,
            startingWeight: 0,
            goalWeight: 0
        };
        
        // App State
        let appState = {
            currentWeight: 0,
            weeklyMealPlan: null,
            waterIntake: 0,
            currentDay: 'wednesday',
            weightLog: [],
            waterLog: [],
            waterGoal: 4,
            soundEnabled: true,
            remindersEnabled: true,
            lastWaterReset: null // Track when water was last reset
        };
        
        // Current modal state
        let currentMeal = null;
        let currentDay = null;
        let currentItems = [];
        
        // Default diet plan
        const defaultPlan = {
            monday: {
                breakfast: ["2-3 boiled eggs", "1 cup of coffee (no sugar)"],
                lunch: ["1 injera", "Misir wot", "Gomen", "1 cup of coffee"],
                dinner: ["Any fruit (apple/orange)", "1 cup of tea"]
            },
            tuesday: {
                breakfast: ["2 boiled eggs", "1 cup coffee"],
                lunch: ["Tilet fitfit OR Duba fitfit (small portion)", "1 cup of coffee"],
                dinner: ["Water melon or Zaba juice (no sugar)"]
            },
            wednesday: {
                breakfast: ["Full with 2 eggs", "1 cup of coffee"],
                lunch: ["Kinche with 2 pieces of carrots", "1 cup coffee"],
                dinner: ["A small salad (lettuce, tomato, onion, lemon)"]
            },
            thursday: {
                breakfast: ["2 eggs + sandwich with grain bread", "1 cup coffee"],
                lunch: ["1 boiled egg", "2 cups of 'Girgir' + 2 cups of firfir (small portion)", "1 cup coffee"],
                dinner: ["Banana or extra tea"]
            },
            friday: {
                breakfast: ["Avocado (¬Ω fruit) + banana (¬Ω fruit)", "1 cup coffee"],
                lunch: ["2 small pieces of potato", "Boiled vegetables", "1 cup coffee"],
                dinner: ["Water melon or Zaba juice"]
            },
            saturday: {
                breakfast: ["2-3 boiled eggs", "1 cup coffee"],
                lunch: ["Tilet fitfit OR Duba fitfit (small portion)", "1 cup coffee"],
                dinner: ["Banana or tea"]
            },
            sunday: {
                breakfast: ["2 eggs + 4 small balls of dabo", "1 cup coffee"],
                lunch: ["1 boiled egg", "2 cups of Girgir", "1 cup coffee"],
                dinner: ["Banana or tea"]
            }
        };
        
        // Food calorie estimates (keep as is)
        const foodCalories = {
            'boiled eggs': 70, // per egg
            'coffee': 2, // per cup
            'injera': 100, // per piece
            'misir wot': 150, // per serving
            'gomen': 80, // per serving
            'kinche': 200, // per serving
            'carrots': 40, // per serving
            'tea': 2, // per cup
            'fruit': 80, // per piece
            'salad': 50, // per serving
            'banana': 105, // per fruit
            'zaba juice': 120, // per glass
            'potato': 160, // per serving
            'vegetables': 50, // per serving
            'dabo': 150, // per 4 balls
            'girgir': 200, // per serving
            'fifir': 180, // per serving
            'avocado': 240, // per ¬Ω fruit
            'sandwich': 300 // per sandwich
        };

        // Initialize the app
        function initApp() {
            loadProfile();
            loadAppState();
            
            // Set up tab navigation
            setupTabNavigation();
            
            // Check if profile is complete
            if (!userProfile.name) {
                showProfileSetup();
                return;
            } 
            
            // Check and reset water for new day - MUST be called before setting up event listeners
            checkAndResetDailyWater();
            
            // Initialize water buttons - FIXED: Proper event listener setup
            setupWaterEventListeners();
            
            updateUI();
            scheduleReminders();
            loadSettings();
            setupPWA();
        }

        // Setup water event listeners - NEW FUNCTION
        function setupWaterEventListeners() {
            // Remove any existing event listeners first
            const waterPlus = document.getElementById('water-plus');
            const waterMinus = document.getElementById('water-minus');
            
            // Clone and replace to remove old event listeners
            const newWaterPlus = waterPlus.cloneNode(true);
            const newWaterMinus = waterMinus.cloneNode(true);
            
            waterPlus.parentNode.replaceChild(newWaterPlus, waterPlus);
            waterMinus.parentNode.replaceChild(newWaterMinus, waterMinus);
            
            // Add new event listeners
            newWaterPlus.addEventListener('click', function() {
                if (appState.waterIntake < appState.waterGoal) {
                    appState.waterIntake += 0.25;
                    updateWaterTracker();
                    showNotification("Great! Keep hydrating üíß", "success");
                } else {
                    showNotification("You've reached your water goal for today! üéâ", "success");
                }
            });
            
            newWaterMinus.addEventListener('click', function() {
                if (appState.waterIntake > 0) {
                    appState.waterIntake -= 0.25;
                    updateWaterTracker();
                }
            });
        }

        // Check and reset water intake for new day - FIXED VERSION
        function checkAndResetDailyWater() {
            const today = new Date().toISOString().split('T')[0];
            
            // If we haven't reset today, reset the water intake
            if (appState.lastWaterReset !== today) {
                appState.waterIntake = 0;
                appState.lastWaterReset = today;
                
                // Log the reset
                const existingEntry = appState.waterLog.find(entry => entry.date === today);
                if (!existingEntry) {
                    appState.waterLog.push({
                        date: today,
                        amount: 0
                    });
                }
                
                updateWaterTracker();
                saveAppState();
                console.log("Water tracker reset for new day:", today);
            }
        }

        // Update water tracker - FIXED VERSION
        function updateWaterTracker() {
            const progress = (appState.waterIntake / appState.waterGoal) * 100;
            
            // Update UI elements
            const waterFill = document.getElementById('water-fill');
            const waterCount = document.getElementById('water-count');
            const waterGoalDisplay = document.getElementById('water-goal-display');
            
            if (waterFill) waterFill.style.width = `${Math.min(progress, 100)}%`;
            if (waterCount) waterCount.textContent = appState.waterIntake.toFixed(2);
            if (waterGoalDisplay) waterGoalDisplay.textContent = appState.waterGoal;
            
            // Log water intake for today
            const today = new Date().toISOString().split('T')[0];
            const existingEntry = appState.waterLog.find(entry => entry.date === today);
            
            if (existingEntry) {
                existingEntry.amount = appState.waterIntake;
            } else {
                appState.waterLog.push({
                    date: today,
                    amount: appState.waterIntake
                });
            }
            
            // Update water chart if we're on the progress tab
            updateCharts();
            
            // Save state
            saveAppState();
            
            console.log("Water updated:", appState.waterIntake, "Goal:", appState.waterGoal);
        }

        // Load app state from localStorage - UPDATED
        function loadAppState() {
            const savedAppState = localStorage.getItem('cordavoAppState');
            if (savedAppState) {
                const parsedState = JSON.parse(savedAppState);
                
                // Merge with existing appState to ensure all properties exist
                appState = {
                    ...appState, // Default values
                    ...parsedState, // Saved values
                    weeklyMealPlan: parsedState.weeklyMealPlan || JSON.parse(JSON.stringify(defaultPlan))
                };
                
                // Ensure currentWeight is set
                if (!appState.currentWeight && userProfile.startingWeight) {
                    appState.currentWeight = userProfile.startingWeight;
                }
                
                // Initialize lastWaterReset if it doesn't exist
                if (!appState.lastWaterReset) {
                    appState.lastWaterReset = new Date().toISOString().split('T')[0];
                }
            } else {
                // Initialize with default values
                appState.weeklyMealPlan = JSON.parse(JSON.stringify(defaultPlan));
                appState.currentWeight = userProfile.startingWeight || 72;
                appState.lastWaterReset = new Date().toISOString().split('T')[0];
            }
        }

        // Load profile from localStorage
        function loadProfile() {
            const savedProfile = localStorage.getItem('cordavoProfile');
            if (savedProfile) {
                userProfile = JSON.parse(savedProfile);
            }
        }

        // Save app state to localStorage
        function saveAppState() {
            localStorage.setItem('cordavoAppState', JSON.stringify(appState));
        }

        // Update the entire UI
        function updateUI() {
            updateHeader();
            updateProgress();
            updateWaterTracker(); // Make sure water tracker is updated
            updateDailyTip();
            loadCurrentDayMeals();
            updateDayDisplay();
            updateWeightLog();
            updateCharts();
            generateWeeklyPlan();
        }

        // ... (keep all your other existing functions like updateProgress, updateWeight, etc.)

        // Generate weekly meal plan display
        function generateWeeklyPlan() {
            const container = document.getElementById('weekly-plan-container');
            if (!container) return;
            
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            
            container.innerHTML = '';
            
            days.forEach(day => {
                const dayPlan = appState.weeklyMealPlan[day];
                if (!dayPlan) {
                    console.warn(`No meal plan found for ${day}`);
                    return;
                }
                
                const dayCapitalized = day.charAt(0).toUpperCase() + day.slice(1);
                
                const dayDiv = document.createElement('div');
                dayDiv.className = 'day-plan';
                dayDiv.innerHTML = `
                    <h4>${dayCapitalized}</h4>
                    <div class="day-plan-item" onclick="editMeal('${day}', 'breakfast')">Breakfast: ${dayPlan.breakfast.join(', ')}</div>
                    <div class="day-plan-item" onclick="editMeal('${day}', 'lunch')">Lunch: ${dayPlan.lunch.join(', ')}</div>
                    <div class="day-plan-item" onclick="editMeal('${day}', 'dinner')">Dinner: ${dayPlan.dinner.join(', ')}</div>
                `;
                
                container.appendChild(dayDiv);
            });
        }

        // Enhanced notification system with sound
        function showNotification(message, type = "info") {
            // Play sound if enabled
            if (appState.soundEnabled) {
                playNotificationSound();
            }
            
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 90px;
                right: 20px;
                padding: 15px;
                border-radius: 8px;
                color: white;
                z-index: 10000;
                max-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                transform: translateX(400px);
                transition: transform 0.3s ease;
            `;
            
            // Set background color based on type
            if (type === "success") {
                notification.style.background = "var(--success)";
            } else if (type === "error") {
                notification.style.background = "var(--error)";
            } else if (type === "warning") {
                notification.style.background = "var(--warning)";
            } else {
                notification.style.background = "var(--secondary)";
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = "translateX(0)";
            }, 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.transform = "translateX(400px)";
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Tab navigation
        function setupTabNavigation() {
            const navButtons = document.querySelectorAll('.nav-btn-bottom');
            
            navButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Remove active class from all buttons and tabs
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    // Show the selected tab
                    const tabId = this.getAttribute('data-tab');
                    const targetTab = document.getElementById(tabId);
                    if (targetTab) {
                        targetTab.classList.add('active');
                    }
                });
            });
        }

        // ... (keep all your other existing functions)

        // Initialize the app when page loads
        window.onload = function() {
            applySavedTheme();
            document.getElementById('mode-toggle').addEventListener('click', toggleMode);
            document.getElementById('settings-toggle').addEventListener('click', openSettingsModal);
            initApp();
        };

        // Debug function to check water state
        function debugWater() {
            console.log("Water State:", {
                intake: appState.waterIntake,
                goal: appState.waterGoal,
                lastReset: appState.lastWaterReset,
                today: new Date().toISOString().split('T')[0],
                log: appState.waterLog
            });
        }

        // You can call debugWater() in console to check water state
    </script>
</body>
</html>
